// src/App.jsx
import React, { useEffect, useState, createContext, useContext } from "react";
import { BrowserRouter as Router, Routes, Route, Link, Navigate, useNavigate } from "react-router-dom";
import axios from "axios";

/*
Kairah Studio + Fame Booster — SPA
- No Firebase. Local auth via localStorage (email-only).
- Connect BACKEND via REACT_APP_BACKEND_URL env var.
- Tailwind CSS classes used; ensure Tailwind is configured in your project.
- Place as `src/App.jsx`. For large projects split components into files.
*/

// ---------- CONFIG ----------
const BACKEND = process.env.REACT_APP_BACKEND_URL || "https://kairah-backend.onrender.com";
const BRAND_GOLD = "#D4AF37";
const BRAND_PLUM = "#3D2C41";
const SOFT_BLUSH = "#E7D2CB";

// ---------- Simple local auth (localStorage) ----------
const AuthContext = createContext();
function useAuth() { return useContext(AuthContext); }

function AuthProvider({ children }) {
  const [user, setUser] = useState(() => {
    try { return JSON.parse(localStorage.getItem("kairah_user")) || null; } catch { return null; }
  });

  useEffect(() => {
    if (user) localStorage.setItem("kairah_user", JSON.stringify(user));
    else localStorage.removeItem("kairah_user");
  }, [user]);

  const signIn = (email, name) => {
    const u = { email, name: name || email.split("@")[0], isPaid: false, plan: "Free", freeVideosLeft: 1, favorites: [], videos: [] };
    setUser(u);
    return u;
  };
  const signOut = () => setUser(null);
  const upgrade = (plan) => setUser(prev => ({ ...prev, isPaid: true, plan }));
  const decrementFree = () => setUser(prev => ({ ...prev, freeVideosLeft: Math.max(0, (prev.freeVideosLeft || 1) - 1) }));
  const addUserVideo = (video) => setUser(prev => ({ ...prev, videos: [video, ...(prev.videos || [])] }));

  return (
    <AuthContext.Provider value={{ user, signIn, signOut, upgrade, decrementFree, addUserVideo, setUser }}>
      {children}
    </AuthContext.Provider>
  );
}

// ---------- Shared Data ----------
const TEMPLATES = [
  { name: "Royal Glimpse", category: "Royal", thumbnail: "https://via.placeholder.com/640x360?text=Royal+Glimpse", viralScore: 88, isPaid: true, captions: ["Feel the royal vibe 👑", "This glow is unstoppable! ✨"], hashtags: ["royal","luxury","viral","glowup"], cta: "Check Kairah Studio for more!", ctaLink: "/studio" },
  { name: "Funny Meme", category: "Funny", thumbnail: "https://via.placeholder.com/640x360?text=Funny+Meme", viralScore: 72, isPaid: false, captions: ["Can't stop laughing 😂", "This is pure gold! 😆"], hashtags: ["funny","meme","lol","viral"], cta: "Try more viral videos at Kairah Studio!", ctaLink: "/studio" },
  { name: "Mini Fantasy", category: "Fantasy", thumbnail: "https://via.placeholder.com/640x360?text=Mini+Fantasy", viralScore: 80, isPaid: true, captions: ["Step into a magical world ✨","Fantasy comes alive! 🧚‍♀️"], hashtags: ["fantasy","magic","viral","dream"], cta: "Create your fantasy video at Kairah Studio!", ctaLink: "/studio" },
  { name: "Quick Quote", category: "Motivational", thumbnail: "https://via.placeholder.com/640x360?text=Quick+Quote", viralScore: 65, isPaid: false, captions: ["Believe and achieve 💪","Words that inspire 🔥"], hashtags: ["motivation","inspire","viral","quotes"], cta: "Get more motivational clips at Kairah Studio!", ctaLink: "/studio" },
  { name: "Cute Baby", category: "Baby", thumbnail: "https://via.placeholder.com/640x360?text=Cute+Baby", viralScore: 60, isPaid: false, captions: ["Cutest thing you'll see today 🍼","Baby vibes overload 😍"], hashtags: ["baby","cute","viral","adorable"], cta: "Make adorable videos at Kairah Studio!", ctaLink: "/studio" },
  { name: "Viral Challenge", category: "Viral", thumbnail: "https://via.placeholder.com/640x360?text=Viral+Challenge", viralScore: 90, isPaid: true, captions: ["Take the challenge now! 🔥","Are you ready to go viral? 🚀"], hashtags: ["viralchallenge","trending","challenge","fyp"], cta: "Join the viral challenge at Kairah Studio!", ctaLink: "/studio" }
];

// ---------- Utility helpers ----------
const copyText = async (t) => {
  try { await navigator.clipboard.writeText(t); alert(`Copied: ${t}`); } catch { alert("Copy failed"); }
};
const logLocalAnalytics = (templateName, type) => {
  const key = "kairah_analytics";
  const raw = JSON.parse(localStorage.getItem(key) || "{}");
  if (!raw[templateName]) raw[templateName] = { clicks: 0, downloads: 0 };
  raw[templateName][type === "download" ? "downloads" : "clicks"] += 1;
  localStorage.setItem(key, JSON.stringify(raw));
};

// ---------- Layout components ----------
function Header() {
  const { user, signOut } = useAuth();
  return (
    <header className="bg-white shadow p-4 flex justify-between items-center">
      <div className="flex items-center gap-3">
        <div style={{ color: BRAND_PLUM }} className="text-2xl font-bold">Kairah</div>
        <div className="text-sm text-gray-500">Studio + Fame Booster</div>
      </div>
      <nav className="space-x-4">
        <Link to="/" className="text-gray-700 hover:text-[#3D2C41]">Home</Link>
        <Link to="/studio" className="text-gray-700 hover:text-[#3D2C41]">Studio</Link>
        <Link to="/fame" className="text-gray-700 hover:text-[#3D2C41]">Fame</Link>
        <Link to="/pricing" className="text-gray-700 hover:text-[#3D2C41]">Pricing</Link>
        {user ? (
          <>
            <Link to="/dashboard" className="text-gray-700 hover:text-[#3D2C41]">Dashboard</Link>
            <button onClick={signOut} className="ml-2 text-sm px-3 py-1 rounded border border-gray-200">Logout</button>
          </>
        ) : (
          <Link to="/signin" className="text-gray-700 hover:text-[#3D2C41]">Login</Link>
        )}
      </nav>
    </header>
  );
}

function Footer() {
  return <footer className="bg-white shadow mt-6 p-4 text-center text-gray-600">© 2025 Kairah. Contact | About | Social Links</footer>;
}

// ---------- Pages ----------

function Home() {
  return (
    <div className="p-6">
      <h1 className="text-3xl font-bold" style={{ color: BRAND_PLUM }}>Kairah Studio</h1>
      <p className="mt-2 text-gray-700">Generate AI videos and boost them to go viral — Studio + Fame Booster in one place.</p>
      <div className="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div className="p-4 bg-white rounded shadow">
          <h3 className="font-bold">Create</h3>
          <p className="text-sm text-gray-600 mt-2">Short, high-quality videos that drive clicks and shares.</p>
        </div>
        <div className="p-4 bg-white rounded shadow">
          <h3 className="font-bold">Boost</h3>
          <p className="text-sm text-gray-600 mt-2">One-click viral captions, hashtags, and trending audios.</p>
        </div>
        <div className="p-4 bg-white rounded shadow">
          <h3 className="font-bold">Monetize</h3>
          <p className="text-sm text-gray-600 mt-2">Convert viral traction into paid subscribers and sales.</p>
        </div>
      </div>
    </div>
  );
}

function Signin() {
  const { signIn } = useAuth();
  const navigate = useNavigate();
  const [email, setEmail] = useState("");
  const [name, setName] = useState("");
  const submit = (e) => {
    e.preventDefault();
    if (!email) return alert("Email required");
    signIn(email.toLowerCase(), name);
    navigate("/studio");
  };
  return (
    <div className="p-6 max-w-md mx-auto">
      <h2 className="text-2xl font-bold" style={{ color: BRAND_PLUM }}>Sign in</h2>
      <form onSubmit={submit} className="mt-4 space-y-3 bg-white p-4 rounded shadow">
        <input value={email} onChange={e => setEmail(e.target.value)} placeholder="Email" className="w-full border px-3 py-2 rounded" />
        <input value={name} onChange={e => setName(e.target.value)} placeholder="Display name (optional)" className="w-full border px-3 py-2 rounded" />
        <button className="w-full bg-[#D4AF37] text-white px-4 py-2 rounded font-bold">Continue</button>
      </form>
    </div>
  );
}

function Pricing() {
  const { upgrade } = useAuth();
  const buy = (plan) => {
    // placeholder: integrate Stripe/PayPal here
    if (!confirm(`Simulate purchase of ${plan}?`)) return;
    upgrade(plan);
    alert(`${plan} activated (simulated).`);
  };
  return (
    <div className="p-6">
      <h2 className="text-2xl font-bold" style={{ color: BRAND_PLUM }}>Pricing</h2>
      <div className="mt-4 grid md:grid-cols-3 gap-4">
        <div className="p-4 bg-white rounded shadow">
          <h3 className="font-bold">Free</h3>
          <p className="text-sm text-gray-600">1 free video — try our Studio</p>
        </div>
        <div className="p-4 bg-white rounded shadow">
          <h3 className="font-bold">Pro</h3>
          <p className="text-sm text-gray-600">Unlimited generation, priority queue</p>
          <button onClick={() => buy("Pro")} className="mt-2 bg-[#D4AF37] px-4 py-2 rounded text-white">Buy Pro (simulate)</button>
        </div>
        <div className="p-4 bg-white rounded shadow">
          <h3 className="font-bold">Diamond</h3>
          <p className="text-sm text-gray-600">Team plans and agency features</p>
          <button onClick={() => buy("Diamond")} className="mt-2 bg-[#3D2C41] px-4 py-2 rounded text-white">Buy Diamond (simulate)</button>
        </div>
      </div>
    </div>
  );
}

function Studio() {
  const { user, decrementFree, addUserVideo } = useAuth();
  const [prompt, setPrompt] = useState("");
  const [selectedTemplate, setSelectedTemplate] = useState(null);
  const [generating, setGenerating] = useState(false);
  const [resultUrl, setResultUrl] = useState(null);

  useEffect(() => {
    if (!selectedTemplate) setResultUrl(null);
  }, [selectedTemplate]);

  const handleGenerate = async () => {
    if (!user) return alert("Sign in first");
    if (!selectedTemplate) return alert("Select a template");
    if (!user.isPaid && user.freeVideosLeft <= 0) return alert("Free video limit reached. Upgrade to Pro.");

    setGenerating(true);
    try {
      const payload = { prompt: prompt || `${selectedTemplate.name} - ${selectedTemplate.category}`, template: selectedTemplate.name, userEmail: user.email };
      const res = await axios.post(`${BACKEND}/api/generate-video`, payload);
      if (res.status === 200 && res.data.success) {
        // update local state - server should also enforce and return freeLeft
        if (!user.isPaid) decrementFree();
        // create local placeholder video entry (server will set real download URL later)
        const vid = { id: `local-${Date.now()}`, template: selectedTemplate.name, status: "queued", queuedAt: new Date().toISOString() };
        addUserVideo(vid);
        alert("Video queued. We'll email you when ready (simulated).");
      } else {
        alert("Generation error: " + (res.data?.detail || JSON.stringify(res.data)));
      }
    } catch (err) {
      console.error(err);
      alert("Server error: " + (err.response?.data?.detail || err.message));
    } finally {
      setGenerating(false);
    }
  };

  const handleDownload = async () => {
    if (!resultUrl) return alert("No video ready");
    logLocalAnalytics(selectedTemplate.name, "download");
    window.open(resultUrl, "_blank");
  };

  return (
    <div className="p-6">
      <h2 className="text-2xl font-bold" style={{ color: BRAND_PLUM }}>Studio — Create Video</h2>
      <div className="mt-4 grid md:grid-cols-3 gap-6">
        <div className="md:col-span-2 bg-white p-4 rounded shadow">
          <div className="flex gap-2">
            <input value={prompt} onChange={e => setPrompt(e.target.value)} placeholder="Describe your idea..." className="flex-1 border px-3 py-2 rounded" />
            <button onClick={() => setPrompt(p => `Viral-enhanced: ${p || "my idea"} 🚀`)} className="bg-[#D4AF37] px-3 py-2 rounded text-white">Prompt Magic</button>
          </div>

          <div className="mt-4">
            <h4 className="font-bold">Templates</h4>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mt-2">
              {TEMPLATES.map(t => (
                <div key={t.name} className={`relative bg-white rounded shadow p-2 cursor-pointer ${selectedTemplate?.name === t.name ? "ring-4" : ""}`} onClick={() => {
                  if (t.isPaid && !user?.isPaid) return alert("Upgrade to access this template");
                  setSelectedTemplate(t);
                }}>
                  <img src={t.thumbnail} alt={t.name} className="rounded w-full h-28 object-cover" />
                  <div className="mt-1 font-bold">{t.name}</div>
                  <div className="text-sm text-gray-500">{t.category}</div>
                  <div className="absolute top-2 right-2 bg-[#E7D2CB] text-[#3D2C41] px-2 py-1 rounded text-sm font-bold">{t.viralScore}⭐</div>
                  {t.isPaid && !user?.isPaid && <div className="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center text-white font-bold">Locked</div>}
                </div>
              ))}
            </div>
          </div>

          <div className="mt-4">
            <button onClick={handleGenerate} disabled={generating} className={`bg-[#3D2C41] text-white px-6 py-3 rounded font-bold ${generating ? "opacity-60" : ""}`}>{generating ? "Generating..." : "Generate Video"}</button>
            <button onClick={handleDownload} className="ml-3 bg-green-600 text-white px-4 py-2 rounded">Download (when ready)</button>
          </div>
        </div>

        <aside className="bg-white p-4 rounded shadow">
          <h4 className="font-bold">Preview</h4>
          <div className="mt-3 h-48 bg-gray-100 rounded flex items-center justify-center">
            {selectedTemplate ? <div className="text-center"><div className="font-bold">{selectedTemplate.name}</div><div className="text-sm mt-2">{selectedTemplate.cta}</div></div> : <div>Select a template</div>}
          </div>
          <div className="mt-4 text-sm text-gray-700">
            <div><strong>Free videos left:</strong> {user ? user.freeVideosLeft : 'Sign in'}</div>
            <div className="mt-2"><strong>Plan:</strong> {user ? user.plan : '—'}</div>
          </div>
        </aside>
      </div>
    </div>
  );
}

function Fame() {
  const { user } = useAuth();
  const [category, setCategory] = useState(null);
  const [selected, setSelected] = useState(null);
  const [trending, setTrending] = useState({ audios: [], hashtags: [] });

  useEffect(() => {
    // fetch trending suggestions from backend
    axios.get(`${BACKEND}/api/trending`).then(res => setTrending(res.data)).catch(() => {
      // fallback sample data
      setTrending({ audios: [{ name: "Energetic Hook", id: "a1" }, { name: "Slow Cinematic", id: "a2" }], hashtags: [{ tag: "fyp", score: 98 }, { tag: "glowup", score: 86 }] });
    });
  }, []);

  const filtered = TEMPLATES.filter(t => (category ? t.category === category : true));

  return (
    <div className="p-6">
      <h2 className="text-2xl font-bold" style={{ color: BRAND_PLUM }}>Fame Booster</h2>

      <div className="mt-4 grid md:grid-cols-4 gap-4">
        <aside className="col-span-1 bg-white p-4 rounded shadow">
          <h4 className="font-bold">Categories</h4>
          <div className="mt-3 space-y-2">
            {["Funny","Baby","Royal","Fantasy","Motivational","Viral"].map(c => (
              <button key={c} onClick={() => setCategory(prev => prev === c ? null : c)} className={`w-full text-left px-3 py-2 rounded ${category === c ? "bg-[#3D2C41] text-white" : "hover:bg-gray-100"}`}>{c}</button>
            ))}
          </div>

          <div className="mt-4">
            <h4 className="font-bold">Trending Audios</h4>
            <ul className="mt-2 space-y-2 text-sm">
              {trending.audios.map(a => <li key={a.id} className="cursor-pointer hover:bg-gray-100 p-1 rounded">{a.name}</li>)}
            </ul>
          </div>
        </aside>

        <main className="col-span-2 bg-white p-4 rounded shadow">
          <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
            {filtered.map(t => (
              <div key={t.name} className="border rounded p-2 relative">
                <img src={t.thumbnail} alt={t.name} className="w-full h-28 object-cover rounded" />
                <div className="mt-1 font-bold">{t.name}</div>
                <div className="text-sm text-gray-500">{t.category}</div>
                <div className="absolute top-2 right-2 bg-[#E7D2CB] text-[#3D2C41] px-2 py-1 rounded">{t.viralScore}⭐</div>
                <div className="mt-2 flex gap-2">
                  <button onClick={() => { setSelected(t); logLocalAnalytics(t.name, "click"); window.open(t.ctaLink, "_blank"); }} className="bg-[#D4AF37] px-3 py-1 rounded text-white text-sm">Use</button>
                  <button onClick={() => copyText(t.captions[0])} className="bg-gray-100 px-3 py-1 rounded text-sm">Copy caption</button>
                </div>
              </div>
            ))}
          </div>
        </main>

        <aside className="col-span-1 bg-white p-4 rounded shadow">
          <h4 className="font-bold">Hashtag Suggestions</h4>
          <div className="mt-2">
            {trending.hashtags.map((h, i) => <div key={i} className="text-sm py-1">#{h.tag} <span className="text-gray-400">({h.score})</span></div>)}
          </div>

          {selected ? (
            <div className="mt-4">
              <h5 className="font-bold">Selected: {selected.name}</h5>
              <div className="mt-2"><strong>Captions</strong></div>
              <div className="mt-1">{selected.captions.map((c, i) => <div key={i} className="text-sm py-1 cursor-pointer" onClick={() => copyText(c)}>{c}</div>)}</div>
              <div className="mt-2"><strong>Hashtags</strong></div>
              <div className="mt-1">{selected.hashtags.map((h, i) => <div key={i} className="text-sm py-1 cursor-pointer" onClick={() => copyText(`#${h}`)}>#{h}</div>)}</div>
            </div>
          ) : <div className="mt-4 text-sm text-gray-500">Select a template to see captions & hashtags</div>}
        </aside>
      </div>
    </div>
  );
}

function Dashboard() {
  const { user } = useAuth();
  const analytics = JSON.parse(localStorage.getItem("kairah_analytics") || "{}");
  return (
    <div className="p-6">
      <h2 className="text-2xl font-bold" style={{ color: BRAND_PLUM }}>Dashboard</h2>
      <div className="mt-4 grid md:grid-cols-2 gap-4">
        <div className="bg-white p-4 rounded shadow">
          <h4 className="font-bold">Your Info</h4>
          <div className="mt-2 text-sm">Email: {user?.email}</div>
          <div className="mt-1 text-sm">Plan: {user?.plan}</div>
          <div className="mt-1 text-sm">Free left: {user?.freeVideosLeft}</div>
        </div>
        <div className="bg-white p-4 rounded shadow">
          <h4 className="font-bold">Analytics (local)</h4>
          <pre className="mt-2 text-sm">{JSON.stringify(analytics, null, 2)}</pre>
        </div>
      </div>
      <div className="mt-4 bg-white p-4 rounded shadow">
        <h4 className="font-bold">Your Videos</h4>
        <ul className="mt-2">
          {user?.videos?.length ? user.videos.map(v => <li key={v.id} className="py-1 border-b">{v.template} — {v.status}</li>) : <li className="text-sm text-gray-500">No videos yet</li>}
        </ul>
      </div>
    </div>
  );
}

function Library() {
  const { user } = useAuth();
  return (
    <div className="p-6">
      <h2 className="text-2xl font-bold" style={{ color: BRAND_PLUM }}>Library</h2>
      <div className="mt-4 grid md:grid-cols-3 gap-4">
        {user?.videos?.length ? user.videos.map(v => (
          <div key={v.id} className="bg-white p-3 rounded shadow">
            <div className="font-bold">{v.template}</div>
            <div className="text-sm text-gray-500">{v.status}</div>
          </div>
        )) : <div className="text-sm text-gray-500">Your saved videos will appear here.</div>}
      </div>
    </div>
  );
}

function Settings() {
  const { user, setUser } = useAuth();
  const [name, setName] = useState(user?.name || "");
  const save = () => {
    setUser(prev => ({ ...prev, name }));
    alert("Saved");
  };
  return (
    <div className="p-6">
      <h2 className="text-2xl font-bold" style={{ color: BRAND_PLUM }}>Settings</h2>
      <div className="mt-4 bg-white p-4 rounded shadow max-w-md">
        <label className="block text-sm">Display name</label>
        <input value={name} onChange={e => setName(e.target.value)} className="w-full border px-3 py-2 rounded mt-1" />
        <button onClick={save} className="mt-3 bg-[#D4AF37] px-4 py-2 rounded text-white">Save</button>
      </div>
    </div>
  );
}

// ---------- App ----------
export default function App() {
  return (
    <AuthProvider>
      <Router>
        <div className="min-h-screen bg-gray-50">
          <Header />
          <main>
            <Routes>
              <Route path="/" element={<Home />} />
              <Route path="/signin" element={<Signin />} />
              <Route path="/pricing" element={<Pricing />} />
              <Route path="/studio" element={<RequireAuth><Studio /></RequireAuth>} />
              <Route path="/fame" element={<RequireAuth><Fame /></RequireAuth>} />
              <Route path="/dashboard" element={<RequireAuth><Dashboard /></RequireAuth>} />
              <Route path="/library" element={<RequireAuth><Library /></RequireAuth>} />
              <Route path="/settings" element={<RequireAuth><Settings /></RequireAuth>} />
              <Route path="*" element={<Navigate to="/" replace />} />
            </Routes>
          </main>
          <Footer />
        </div>
      </Router>
    </AuthProvider>
  );
}

// ---------- Route guard ----------
function RequireAuth({ children }) {
  const { user } = useAuth();
  if (!user) return <Navigate to="/signin" replace />;
  return children;
}
